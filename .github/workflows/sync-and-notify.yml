name: Sync and Notify Protobufs Updates

permissions:
  contents: write # å…³é”®ä¿®å¤ï¼šèµ‹äºˆè„šæœ¬å†™å…¥æƒé™ï¼Œç¡®ä¿èƒ½æŠŠæ›´æ–° Push å›å»

on:
  schedule:
    # æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä½ çš„ fork
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          ref: master             # æ˜ç¡®æŒ‡å®š master åˆ†æ”¯
          fetch-depth: 0          # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨å†…ç½® token é‰´æƒ
          
      # 2. é…ç½® Git
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
      # 3. æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥
      - name: Sync with upstream
        id: sync
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/SteamDatabase/Protobufs.git || true
          
          # è·å–ä¸Šæ¸¸æœ€æ–°å†…å®¹
          git fetch upstream master
          
          # è·å–å½“å‰æœ¬åœ°æœ€æ–° commit SHA
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "å½“å‰ SHA: $CURRENT_SHA"
          
          # è·å–ä¸Šæ¸¸æœ€æ–° commit SHA
          UPSTREAM_SHA=$(git rev-parse upstream/master)
          echo "ä¸Šæ¸¸ SHA: $UPSTREAM_SHA"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ›´æ–°
          if [ "$CURRENT_SHA" != "$UPSTREAM_SHA" ]; then
            echo "âœ… æ£€æµ‹åˆ°æ–°æ›´æ–°ï¼"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # è·å–æ–° commit çš„è¯¦ç»†ä¿¡æ¯
            COMMIT_MESSAGE=$(git log upstream/master -1 --pretty=format:"%s")
            COMMIT_AUTHOR=$(git log upstream/master -1 --pretty=format:"%an")
            COMMIT_DATE=$(git log upstream/master -1 --pretty=format:"%ci")
            COMMIT_URL="https://github.com/SteamDatabase/Protobufs/commit/$UPSTREAM_SHA"
            SHORT_SHA=$(echo $UPSTREAM_SHA | cut -c1-7)
            
            # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆé¿å… JSON æ ¼å¼é”™è¯¯ï¼‰
            COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
            
            echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
            echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
            echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
            echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
            echo "commit_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
            echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
            
            # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
            git merge upstream/master --allow-unrelated-histories -m "Sync with upstream"
            
            # ã€è¿™é‡Œè§£å†³äº†ä½ çš„é—®é¢˜ã€‘æ¨é€åˆ°ä½ çš„ä»“åº“
            # åªæœ‰è¿™é‡ŒæˆåŠŸäº†ï¼Œä½ çš„ä»“åº“æ‰ä¼šæ›´æ–°ï¼Œä¸‹ä¸€æ¬¡å°±ä¸ä¼šé‡å¤å‘é€šçŸ¥äº†
            git push origin master
          else
            echo "â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
      # 4. å‘é€ Discord é€šçŸ¥ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
      - name: Send Discord notification
        if: steps.sync.outputs.has_updates == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": null,
                 \"embeds\": [{
                   \"title\": \"ğŸ“¦ Steam Protobufs æœ‰æ–°æ›´æ–°ï¼\",
                   \"description\": \"${{ steps.sync.outputs.commit_message }}\",
                   \"url\": \"${{ steps.sync.outputs.commit_url }}\",
                   \"color\": 16744272,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ“ æäº¤è€…\",
                       \"value\": \"${{ steps.sync.outputs.commit_author }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ•’ æäº¤æ—¶é—´\",
                       \"value\": \"${{ steps.sync.outputs.commit_date }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ”— Commit\",
                       \"value\": \"[\`${{ steps.sync.outputs.short_sha }}\`](${{ steps.sync.outputs.commit_url }})\"
                     }
                   ],
                   \"footer\": {
                     \"text\": \"SteamDatabase/Protobufs\",
                     \"icon_url\": \"https://avatars.githubusercontent.com/u/8016191?s=200&v=4\"
                   },
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               "$DISCORD_WEBHOOK"
               
      # 5. è¾“å‡ºç»“æœæ€»ç»“
      - name: Summary
        run: |
          if [ "${{ steps.sync.outputs.has_updates }}" == "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼å·²å‘é€ Discord é€šçŸ¥"
          else
            echo "â„¹ï¸ æ— æ–°æ›´æ–°"
          fi
